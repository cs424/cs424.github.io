---
layout: post
title:  Practical 5
author: CS424
date:   2014-10-22 11:00:00
categories: practical
---

**1.**
Finish Practical Sheet 4.    Run the tests (`rake test`) to make
sure everything works as it should.


**2. Migrations.** Add a few more books to your shopping cart, until
you have several copies of at least one book.  At that point the
shopping cart starts looking kind of stupid, listing the same product
several times.  Can those computers not keep track of the number of
times a product is chosen?  They can.  For this, you just have to _add
a column_ to the line items table in the database.

The structure of the database can be changed by
_migrations_, and migrations can be generated by rails.  To add a
`quantity` column of type `integer` to the `line_items` table, type
the command:

    rails generate migration add_quantity_to_line_items quantity:integer

then find the generated file in `db/migrate`. It is called: `____________________________________`.  (Enter the name of this file in the comment box below.)

**3.** Add the argument `, :default => 1` to the
`add_column` function call within the `change()` method in this file (so that a new line item
starts off with `quantity` set to 1, and existing line items get a value 1
for their new column 'quantity').  Then run the migration:

    rake db:migrate

**4.** In order to _use_ the new `quantity` field, the 
logic behind the pages needs to be changed.  Logic resides in the controller.
Line items are controlled by which controller in which file?
  Replace the line
`@line_item = @cart.line_items.build(...)` 
in the `create` method of this controller
by
{% highlight ruby %}
@line_item = @cart.add_product(product.id)
{% endhighlight %}
Moreover, in the line item model, add `:quantity` to the list
of `attr_accessible` components.


**5.** While Rails does a lot of things automatically, it cannot know
_how_  you intend to add a product to a cart.  The method `add_product` needs to be defined explicitly, in the cart model (which file?).
Based on the given product id, this method needs to find out
whether this product is already referred to by one of the cart's line items
(this is the list `line_items` which exists as a consequence of the
`has_many :line_items` declaration) and in that case increment the `quantity`, or create a new line item for the product and add it to the cart's list of line items.  In either
case, the line item needs to be returned to the caller:
{% highlight ruby %}
def add_product(product_id)
  current_item = line_items.find_by(product_id: product_id)
  if current_item
    current_item.quantity += 1
  else
    current_item = line_items.build(product_id: product_id)
  end
  current_item
end
{% endhighlight %}

**6.** Add `<%= item.quantity %> &times;` to the product
title in the page template that displays the shopping cart (which
file?).  Now, add a few more products to your cart and watch the
quantities increase.

**6a.** If all works fine, commit the changes to your local `git`
repository, and push them to the `github` cloud.

    git add .
    git commit -m "added quantity column to line items table."
    git push


**7.** Unfortunately, this change in the database structure does not
automatically get rid of the older repeated entries. What's needed is
another migration to clean up the entire database!  The command

    rails generate migration combine_items_in_cart

creates the migration (where?), but doesn't specify what to do.

**8.** In order to adjust all line items to the new setup, one
needs to arrange a loop over all carts (`Cart.all.each do |cart|
... end`).  Inside the loop, it has to be checked whether a
product appears in several line items, and if so, these instances need
to be replaced by a single line item, with the correct quantity.

Rename the method 'change' to 'up' in the migration file.
Then
insert the above loop into the `up()`
method, and insert the following code into the loop:
{% highlight ruby %}
# count the number of copies of each product in the cart
sums = cart.line_items.group(:product_id).sum(:quantity)
sums.each do |product_id, quantity|
  if quantity > 1

    # remove individual items
    cart.line_items.where(product_id: product_id).delete_all

    # replace with single item and record quantity
    item = cart.line_items.build(product_id: product_id)
    item.quantity = quantity
    item.save!
  end
end
{% endhighlight %}
Then run the migration: `rake db:migrate`, and reload your shopping cart.
Does it look any different?

**9.** Migrations are normally designed so that they can be reversed
if necessary.  This can be specified as a single `change()` method
which can be applied forwards and backwards (study the existing
migrations in the `db/migrate` folder and try to imagine how each of
the operations in there can be undone).  Or it is specified by a pair
of methods, one called 'up()' and one called 'down()'.  Here we already have 
an 'up()' method, it's counterpart however is missing.

**10.**  Design  a  `down()`  method that  undoes  the
 latest change: it needs to replace  each line item with a quantity of
 more than 1  by a corresponding sequence of  line items with quantity
 1. (Hint: use 
`1`, 
`destroy`, 
`each`, 
`end`, 
`item`, 
`product_id`,
`times`, 
to fill the gaps.)
{% highlight ruby %}
# split items with quantity>1 into multiple items
LineItem.where("quantity>1").______ do |item|

  # add individual items
  item.quantity.______ do 
    LineItem.create(cart_id: item.cart_id,
      product_id: ______.______, quantity: ______)
  ______

  # remove original item
  item.______      
end
{% endhighlight %}
Insert the code into its place.  Then run `rake db:rollback` and reload the cart.  
Then `rake db:migrate` again.

**10a.** If all works fine, commit the changes to your local `git`
repository, and push them to the `github` cloud.

**11. Deleting Objects.** Apropos undoing: there needs to be a way
to empty the cart. One possible solution is to simply delete the entire cart
from the database. Add this button
{% highlight html+ruby %}
<%= button_to 'Empty cart', @cart, method: :delete,
      data: { confirm: 'Are you sure?' } %>
{% endhighlight %}
to the cart display page. (Which file? Where in the file?)

**12.** Clicking this button will eventually invoke the
`destroy` action of the cart controller.  (Which file? Where in the file?)  Modify this method as follows:
Add the line

    session[:cart_id] = nil

after `@cart` receives the `destroy` method.  And replace the
`format.html` block with
{% highlight ruby %}
format.html { redirect_to(store_url, notice: 'Your cart is currently empty') }
{% endhighlight %}
Then try and empty your cart, and shop for more.  Which further improvements should be made?  (Use the comment box below to make some suggestions.)

**12a.** If all works fine, commit the changes to your local `git`
repository, and push them to the `github` cloud.

