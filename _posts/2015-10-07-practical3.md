---
layout: post
title:  Practical 3
author: CS424
date:   2015-10-07 11:00:00
categories: practical
---

**0.** Finish Practical Sheet 2.  Run the tests (`rake test`) to make
sure everything works fine.

If you wish to access your repository on `github` from a different machine, 
follow the instructions to generate a new `ssh` key on that machine and copy
the _public_ key onto `github`.  Then use the `git clone` command to make
a clone of that repository on your current machine.

If you need to update the clone on this machine to reflect the work
that you did on another machine, just type

    git pull

at the command line (in the root directory of the application).  Of
course this only works if you copied the previous work onto the
`github` cloud with the

    git push

command.

**1. Controllers.**
A controller is responsible for a specific part of an application, and
consists of Ruby code that defines methods for the actions in this
part of the application.  The part that needs to be designed now is
how our online store presents itself to a potential buyer, i.e., the
_catalog_. Let's call the user facing part of the application the `store`.
Let's make the catalog visible to the user through an `index` action.
An _action_ is a controller method and a view template.  The command

    rails generate controller store index

will create a file `store_controller.rb` 
which defines a class `StoreController`.

Find the file, and describe what's in there.  Then point your browswer to 

    http://localhost:3000/store/index

to see the effect of issuing the `index` command to the `store`
controller of your application.
This works, because the `rails generate controller` command 
has added the line `get store/index` to the routes in
the file `config/routes.rb`, so that the application now responds to
`store/index` requests (as part of the URL).

**1a.** If all works fine, it might be a good idea to commit the
current state of the files that make up the depot application to the
repository.

    git add .
    git commit -m "generated store controller"
    git push

**2.**
While you look at the file `routes.rb` you might as well modify it
so that the catalog becomes the _home page_ of our application:
near the comment '`You can have the root of your site routed`'
enter the line
{% highlight ruby %}
root :to => 'store#index', :as => 'store'
{% endhighlight %}
Then reload the page `localhost:3000`.  Can you see the shiny product
listing?  Why not? 

**3.** In order to properly wire up the `store/index` action, a few
files will need to be modified.

For now, the store controller contains only a skeletal definition of
an `index` method.  Add the line
{% highlight ruby %}
@products = Product.order(:title)
{% endhighlight %}
to that method (i.e., before the first `end`).  Here, `Product` is our
old product model, and `order` is an automatically generated method
that creates a list of all products in the database, ordered by their
title.  This list is assigned to the _instance variable_ `@products`,
so it becomes part of the instance of the controller that deals with
`store/index` requests.  Reload `localhost:3000`.  Any visible change?
Why not?

**4.** Recall that an action consists of a controller method _and_ a
view template.  
We've defined the controller method in the previous step.
Let's update the view template: replace the store
index view template (which file?) by
{% highlight html+ruby %}
<% if notice %>
  <p id="notice"><%= notice %></p>
<% end %>

<h1>Your Pragmatic Catalog</h1>

<% @products.each do |product| %>
  <div class="entry">
    <%= image_tag(product.image_url) %>
    <h3><%= product.title %></h3>
    <%= sanitize product.description %>
    <div class="price_line">
      <span class="price"><%= product.price %></span>
    </div>
  </div>
<% end %>
{% endhighlight %}
This mixture of HTML and Ruby (enclosed in `<%` and `%>`)
essentially sets up a loop over the list `@products`
and displays each product in turn, inside a `<div>` element
of class `entry`.  How does the browser know how to
format these elements? 
How does the view know about the `@products` variable?

Reload the page, and now find the catalog.

**4a.** If all works fine, commit the changes to your local `git`
repository, and push them to the `github` cloud:

    git add .
    git commit -m "added a store index action"
    git push

**5.** Still, the catalog could look much nicer.  Let's apply some
styling.  Open the file `app/assets/stylesheets/store.css.scss`
(which was automatically generated by the last `rails` command) and add
{% highlight scss %}
.store {
}
{% endhighlight %}
to its bottom.  This bracket provides a place, where all the style
information relating to elements of class `store` can be collected.

**6.** Add the following, line by line, to that bracket (i.e. between
`{` and `}`) and reload the catalog page after each line to see its
effect.
{% highlight scss %}
h1 {
  margin: 0;
  padding-bottom: 0.5em;
  font: 150% sans-serif;
  color: #226;
  border-bottom: 3px dotted #77d;
}
{% endhighlight %}
Then the following ...
{% highlight scss %}
/* An entry in the store catalog */
.entry {
  overflow: auto;
  margin-top: 1em;
  border-bottom: 1px dotted #77d;
  min-height: 100px;
}
{% endhighlight %}
And then the following inside the `.entry{ ... }` bracket:
{% highlight scss %}
img {
  width: 80px;
  margin-right: 5px;
  margin-bottom: 5px;
  position: absolute;
}

h3 {
  font-size: 120%;
  font-family: sans-serif;
  margin-left: 100px;
  margin-top: 0;
  margin-bottom: 2px;
  color: #227;
}

p, div.price_line {
  margin-left: 100px;
  margin-top: 0.5em;
  margin-bottom: 0.8em;
}

.price {
  color: #44a;
  font-weight: bold;
  margin-right: 3em;
}
{% endhighlight %}

**6a.** If all looks well, update the repository and push to the cloud.

    git commit -a -m "added and styled catalog view"
    git push

**7. Layouts.**
A _layout_ is an HTML frame that applies to 
a whole range of pages.  Ours is in `app/views/layouts/application.html.erb`.
It contains the 
required `<html>`, `<head>`, and `<body>` elements, and
sets the title of the browser window. 
Edit the `<title>` element in the `<head>` to look like
{% highlight html %}
<title>Pragprog Books Online Store</title>
{% endhighlight %}
Then add
{% highlight html+ruby %}
<div id="banner">
  <%= image_tag("logo.png") %>
  <%= @page_title || "Pragmatic Bookshelf" %>
</div>
{% endhighlight %}
to the body, before `<%= yield %>`.  

**8.** This adds a banner consisting of an image and some text to the top 
of the page.  For this to work as intended, download the file

* [app/assets/images/logo.png](http://schmidt.nuigalway.ie/cs424/depot/app/assets/images/logo.png)

from <http://schmidt.nuigalway.ie/cs424/depot> and copy it into the
corresponding location inside your own depot application.

Then rename the file `app/assets/stylesheets/application.css`
to `app/assets/stylesheets/application.css.scss` (how?)
and add the following to it, line by line, and watch the effects:
{% highlight scss %}
#banner {
  background: #9c9;
  padding: 10px;
  border-bottom: 2px solid;
  font: small-caps 40px/40px "Times New Roman", serif;
  color: #282;
  text-align: center;

  img {
    float: left;
  }
}
{% endhighlight %}
Also add the following:
{% highlight scss %}
#notice {
  color: #000 !important;
  border: 2px solid red;
  padding: 1em;
  margin-bottom: 2em;
  background-color: #f0f0f0;
  font: bold smaller sans-serif;
}
{% endhighlight %}
(This won't have any visible effects until later, when a notice is issued and
displayed.)

**9.** In the layout file, `app/views/layouts.application.html.erb`,
replace `<%= yield %>` by
{% highlight html+ruby %}
<div id="columns">
  <div id="side">
    <ul>
	<li><a href="http://www....">Home</a></li>
	<li><a href="http://www..../faq">Questions</a></li>
	<li><a href="http://www..../news">News</a></li>
	<li><a href="http://www..../contact">Contact</a></li>
    </ul>
  </div>
  <div id="main">
    <%= yield %>
  </div>
</div>
{% endhighlight %}
This adds a sidebar with a list of (mock) links to the page. In order to
have this blend in with the rest, we add some more style to 
`app/assets/stylesheets/application.css.scss`:
{% highlight scss %}
#columns {
  background: #141;

  #main {
    margin-left: 17em;
    padding: 1em;
    background: white;
  }

  #side {
    float: left;
    padding: 1em 2em;
    width: 13em;
    background: #141;
    color: white;

    ul {
      padding: 0;
      li {
        list-style: none;
        a {
          color: #bfb;
	  font-size: small;
	}
      }
    }
  }
}
{% endhighlight %}
Again, if you add this line by line (taking care that all opening braces are
always matched by closing ones), you can watch the effects of the individual 
rules.

**10.**
What's wrong with the formatting of prices of products? 
Find the place where they are printed and
 replace `product.price` with `number_to_currency(product.price)` to fix it.
Sometimes it can be useful to try out a newly found functionality in a separate environment.
The rails _console_ is such a place.  It allows you to interact with your
application from a command line. Type

    rails console

to start it up.
The price formatting helper method can be accessed
as `helper.number_to_currency` inside the rails console.
Google the documentation of `number_to_currency` and 
experiment with its options.  How can you make it print four billion
euro, with groups of three digits separated by spaces?

**10a.** If all works fine, commit the changes to your local `git`
repository, and push them to the `github` cloud.

**11. Functional Testing.**
The command `assert_select` is
something like the Swiss army knife for functional testing. 
It allows you to test properties of specific nodes in the document tree.
Add the
following four examples of its use to the `"should get index"` test
in the file
`store_controller_test.rb` (which directory?):
{% highlight ruby %}
assert_select '#columns #side a', minimum: 4
assert_select '#main .entry', 3
assert_select 'h3', 'Book1'
assert_select '.price', /\$[,\d]+\.\d\d/
{% endhighlight %}
These tests use CSS selector notation to refer to parts of the HTML that is
returned.  The first selects all `<a>` elements which sit
inside an element with `id="side"` inside an element with
`id="columns"`, and expects to find at least 4 of them
(where?).
The remaining tests verify that all products 
(as specified for test purposes in the file `fixtures.yml`)
are displayed: there should be 3 elements with `class="entry"`
inside an element with `id="main"`,
one `<h3>` element should contain the text `'Book1'`,
and all elements with `class="price"` should be formatted 
as dollar prices.

**12.**  
Add a date and time to the sidebar.
Formulate a test that checks its presence.

**12a.** If all works fine, commit the changes to your local `git`
repository, and push them to the `github` cloud.

